name: Daily Green 4x

on:
  workflow_dispatch:
  schedule:
    # Dhaka times: 11:00, 15:00, 18:45, 22:00 (UTC+6)
    # convert to UTC: 05:00, 09:00, 12:45, 16:00
    - cron: "0 5 * * *"     # 11:00 Dhaka
    - cron: "0 9 * * *"     # 15:00 Dhaka
    - cron: "45 12 * * *"   # 18:45 Dhaka
    - cron: "0 16 * * *"    # 22:00 Dhaka

permissions:
  contents: write

jobs:
  commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Create daily folder and write slot file
        env:
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          # Use Dhaka timezone for folder naming (user requested human date)
          export TZ='Asia/Dhaka'

          # day, month, year
          DAY_NUM=$(date +%-d)
          MONTH_NAME=$(date +%B)
          YEAR_NUM=$(date +%Y)

          # compute ordinal suffix
          d100=$((DAY_NUM % 100))
          if [ "$d100" -ge 11 ] && [ "$d100" -le 13 ]; then
            SUFFIX="th"
          else
            case $((DAY_NUM % 10)) in
              1) SUFFIX="st" ;;
              2) SUFFIX="nd" ;;
              3) SUFFIX="rd" ;;
              *) SUFFIX="th" ;;
            esac
          fi

          FOLDER_NAME="${MONTH_NAME} ${DAY_NUM}${SUFFIX} ${YEAR_NUM}"
          mkdir -p "$FOLDER_NAME"

          # choose filename based on Dhaka local time of the run (HH-MM)
          FILE_NAME="$(date +%H-%M).txt"
          FILE_PATH="${FOLDER_NAME}/${FILE_NAME}"

          # write a small unique line so each run creates a change
          echo "Timestamp (UTC): $(date -u +"%Y-%m-%d %H:%M:%SZ")" >> "$FILE_PATH"
          echo "Local (Dhaka): $(date +"%Y-%m-%d %H:%M:%S %Z") by $GITHUB_ACTOR" >> "$FILE_PATH"

          # show what we did
          echo "Wrote: $FILE_PATH"
          ls -l "$FOLDER_NAME"

      - name: Commit & push
        env:
          GIT_AUTHOR_NAME: ${{ github.actor }}
          GIT_AUTHOR_EMAIL: ${{ github.actor }}@users.noreply.github.com
        run: |
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git add --all
          git commit -m "Daily slot: $(date -u +"%Y-%m-%d %H:%M:%SZ") by ${GIT_AUTHOR_NAME}" || echo "Nothing to commit"
          git push
